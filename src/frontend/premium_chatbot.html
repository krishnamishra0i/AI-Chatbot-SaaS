<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ Premium AI Avatar Chatbot - Voice & Video Enabled</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f8fafc;
            --border: #e5e7eb;
            --text: #374151;
            --shadow: 0 20px 40px rgba(0,0,0,0.1);
            --shadow-lg: 0 30px 60px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1600px;
            height: 90vh;
        }

        /* AVATAR SECTION */
        .avatar-section {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .avatar-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .avatar-header h2 {
            color: var(--dark);
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .avatar-video {
            width: 100%;
            aspect-ratio: 9 / 12;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        /* Floating avatar label (bottom-right) */
        .avatar-label {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(102, 126, 234, 0.18);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            z-index: 5;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .avatar-label .agent-title {
            margin-right: 8px;
            font-size: 0.95rem;
        }

        .avatar-label .status-inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06));
            color: var(--success);
            font-weight: 700;
            font-size: 0.8rem;
        }

        /* Ensure any <img> inside avatar area is nicely fitted */
        .avatar-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: 12px;
            display: block;
        }

        .avatar-placeholder {
            text-align: center;
        }

        .avatar-placeholder p {
            margin-top: 16px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .avatar-status {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text);
        }

        .status-badge.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* CHAT SECTION */
        .chat-section {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .chat-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-bubble {
            background: var(--light);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: flex-end;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text);
            opacity: 0.4;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* INPUT SECTION */
        .input-section {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .input-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--light);
            border-radius: 50px;
            padding: 0 16px;
        }

        .input-group input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1rem;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
        }

        .input-group input::placeholder {
            color: var(--text);
            opacity: 0.5;
        }

        .input-group input:focus {
            outline: none;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .mic-btn {
            background: var(--danger);
            color: white;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
        }

        .mic-btn:hover {
            background: #dc2626;
        }

        .mic-btn.recording {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .audio-output {
            background: var(--light);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.85rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* VOICE CONTROL */
        .voice-control {
            background: var(--light);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .voice-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: white;
            color: var(--text);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .message-bubble {
                max-width: 90%;
            }
        }

        @media (max-width: 640px) {
            .container {
                height: auto;
                min-height: 100vh;
            }

            .input-group {
                padding: 0 12px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .avatar-video {
                aspect-ratio: 16 / 9;
            }
        }

        /* SCROLLBAR */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--text);
        }

        .config-section {
            background: var(--light);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }

        .config-section label {
            display: block;
            margin-bottom: 6px;
            color: var(--text);
            font-weight: 500;
        }

        .config-section select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- AVATAR SECTION -->
        <div class="avatar-section">
            <div class="avatar-header">
                <h2>üé¨ AI Avatar</h2>
                <p>Powered by D-ID Video API</p>
            </div>

            <div class="avatar-video" id="avatar-video">
                <div class="avatar-placeholder">
                    <div style="font-size: 3rem;">üé≠</div>
                    <p>Avatar video will appear here</p>
                    <p style="font-size: 0.75rem; margin-top: 12px;">Using D-ID Video API</p>
                </div>

                <!-- Floating avatar label (bottom-right) -->
                <div class="avatar-label" aria-hidden="false">
                    <span class="agent-title">Ambassador Paul AI Customer Support Agent</span>
                    <span class="status-inline"><span style="width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--success);margin-right:6px;"></span>Online</span>
                </div>
            </div>

            <div class="avatar-status">
                <div class="status-badge online">
                    <div class="status-dot"></div>
                    Avatar Online
                </div>
                <div class="status-badge">
                    üéôÔ∏è Voice Enabled
                </div>
            </div>

            <div class="config-section">
                <label>Avatar Voice:</label>
                <select id="avatar-voice">
                    <option value="en-US-AriaNeural">Aria (Female)</option>
                    <option value="en-US-GuyNeural">Guy (Male)</option>
                    <option value="en-US-AmberNeural">Amber (Female)</option>
                    <option value="en-US-BrandonNeural">Brandon (Male)</option>
                </select>
            </div>

            <div class="config-section">
                <label>Microphone Input:</label>
                <div class="voice-toggle">
                    <button class="toggle-btn active" onclick="toggleMicrophone(true)">üé§ ON</button>
                    <button class="toggle-btn" onclick="toggleMicrophone(false)">üîá OFF</button>
                </div>
            </div>
        </div>

        <!-- CHAT SECTION -->
        <div class="chat-section">
            <div class="chat-header">
                <h1>üí¨ AI Chat Assistant</h1>
                <p>Voice + Text Enabled ‚Ä¢ Real-time Responses</p>
            </div>

            <div class="messages-container" id="messages">
                <div class="message bot">
                    <div>
                        <div class="message-bubble">
                            üëã Hello! I'm your AI Avatar Assistant. I can understand both voice and text input. Try asking me something or click the microphone to speak!
                        </div>
                        <div class="message-meta">Just now</div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <button class="btn mic-btn" id="mic-btn" onclick="toggleRecording()" title="Click to record voice">üé§</button>
                
                <div class="input-group">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Type your question or use voice..." 
                        onkeypress="handleKeyPress(event)"
                    >
                </div>

                <button class="btn btn-primary btn-icon" onclick="sendMessage()" title="Send message">
                    ‚û§
                </button>
            </div>

            <div class="voice-control" id="voice-control" style="display: none;">
                <div class="audio-output" id="audio-output">
                    üîä Playing response...
                </div>
                <button class="btn btn-secondary btn-icon" onclick="stopAudio()" title="Stop audio">
                    ‚èπ
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiBaseUrl: 'http://localhost:8000',
            endpoints: {
                chat: '/api/chat',
                health: '/health'
            }
        };

        // State
        let state = {
            isRecording: false,
            isSpeaking: false,
            messageCount: 0,
            voiceEnabled: true,
            currentAudio: null,
            mediaRecorder: null,
            audioChunks: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', initialize);

        async function initialize() {
            // Check server health
            try {
                const r = await fetch(CONFIG.apiBaseUrl + CONFIG.endpoints.health);
                if (r.status === 200) {
                    console.log('‚úÖ Server connected');
                }
            } catch (e) {
                console.error('‚ùå Server connection failed');
            }

            // Request microphone access
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.mediaRecorder.ondataavailable = (e) => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = handleAudioRecorded;
                console.log('‚úÖ Microphone access granted');
            } catch (e) {
                console.warn('‚ö†Ô∏è Microphone access denied:', e);
                state.voiceEnabled = false;
                document.getElementById('mic-btn').style.opacity = '0.5';
            }
        }

        function toggleRecording() {
            if (!state.voiceEnabled) {
                alert('Microphone access required for voice input');
                return;
            }

            if (state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!state.mediaRecorder) {
                alert('Microphone not available');
                return;
            }

            state.audioChunks = [];
            state.isRecording = true;
            state.mediaRecorder.start();

            const btn = document.getElementById('mic-btn');
            btn.classList.add('recording');
            btn.textContent = '‚èπÔ∏è';
            btn.title = 'Click to stop recording';
        }

        function stopRecording() {
            if (!state.mediaRecorder) return;

            state.isRecording = false;
            state.mediaRecorder.stop();

            const btn = document.getElementById('mic-btn');
            btn.classList.remove('recording');
            btn.textContent = 'üé§';
            btn.title = 'Click to record voice';
        }

        async function handleAudioRecorded() {
            const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
            
            // Convert audio to text using Web Speech API (fallback)
            try {
                const text = await transcribeAudio(audioBlob);
                if (text) {
                    document.getElementById('message-input').value = text;
                    sendMessage();
                }
            } catch (e) {
                console.error('Transcription failed:', e);
                alert('Voice transcription failed. Please check your microphone.');
            }
        }

        async function transcribeAudio(blob) {
            // Use simple Web Speech API for transcription
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Send to server for transcription
                        const formData = new FormData();
                        formData.append('audio', blob);
                        
                        const r = await fetch(CONFIG.apiBaseUrl + '/api/transcribe-audio', {
                            method: 'POST',
                            body: formData
                        });

                        if (r.ok) {
                            const data = await r.json();
                            resolve(data.transcription || '');
                        } else {
                            // Fallback: show placeholder
                            resolve('[Could not transcribe - try typing instead]');
                        }
                    } catch (err) {
                        console.error('Transcription error:', err);
                        resolve('');
                    }
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';

            // Add user message
            addMessage(message, 'user');

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch(CONFIG.apiBaseUrl + CONFIG.endpoints.chat, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        language: 'en'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    hideTyping();
                    addMessage(data.response, 'bot');

                    // Generate voice response
                    if (state.voiceEnabled) {
                        await generateVoiceResponse(data.response);
                    }
                } else {
                    hideTyping();
                    addMessage('‚ùå Failed to get response. Please try again.', 'bot');
                }
            } catch (e) {
                hideTyping();
                console.error('Chat error:', e);
                addMessage('‚ùå Connection error. Please check your connection.', 'bot');
            }
        }

        async function generateVoiceResponse(text) {
            try {
                // Use Web Speech API for TTS
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = window.speechSynthesis.getVoices()[0];
                utterance.rate = 1;
                utterance.pitch = 1;
                utterance.volume = 1;

                state.currentAudio = utterance;
                state.isSpeaking = true;

                document.getElementById('voice-control').style.display = 'flex';

                utterance.onend = () => {
                    state.isSpeaking = false;
                    document.getElementById('voice-control').style.display = 'none';
                };

                window.speechSynthesis.speak(utterance);
            } catch (e) {
                console.error('TTS error:', e);
            }
        }

        function stopAudio() {
            window.speechSynthesis.cancel();
            document.getElementById('voice-control').style.display = 'none';
            state.isSpeaking = false;
        }

        function toggleMicrophone(enabled) {
            state.voiceEnabled = enabled;
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addMessage(text, type) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const timeStr = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            messageDiv.innerHTML = `
                <div>
                    <div class="message-bubble">${escapeHtml(text)}</div>
                    <div class="message-meta">${timeStr}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            state.messageCount++;
        }

        function showTyping() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
